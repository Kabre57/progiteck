groups:
  - name: progitek_alerts
    rules:
      # Alerte si l'API est down
      - alert: Progitek_API_Down
        expr: up{job="progitek-api"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "L'API Progitek est inaccessible"
          description: "L'API Progitek n'a pas répondu depuis plus d'1 minute"

      # Alerte si le taux d'erreur est élevé
      - alert: High_Error_Rate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Taux d'erreur élevé détecté"
          description: "Le taux d'erreur 5xx est supérieur à 10% depuis 2 minutes"

      # Alerte si la latence est élevée
      - alert: High_Response_Time
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "Temps de réponse élevé"
          description: "Le 95e percentile du temps de réponse est supérieur à 2 secondes"

      # Alerte si l'utilisation mémoire est élevée
      - alert: High_Memory_Usage
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes > 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Utilisation mémoire élevée"
          description: "L'utilisation mémoire est supérieure à 90% depuis 5 minutes"

      # Alerte si l'utilisation CPU est élevée
      - alert: High_CPU_Usage
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Utilisation CPU élevée"
          description: "L'utilisation CPU est supérieure à 80% depuis 5 minutes"

      # Alerte si l'espace disque est faible
      - alert: Low_Disk_Space
        expr: (node_filesystem_avail_bytes / node_filesystem_size_bytes) < 0.1
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Espace disque faible"
          description: "L'espace disque disponible est inférieur à 10%"

      # Alerte si la base de données est inaccessible
      - alert: Database_Connection_Failed
        expr: up{job="postgres"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Connexion à la base de données échouée"
          description: "Impossible de se connecter à PostgreSQL depuis plus d'1 minute"

      # Alerte si Redis est inaccessible
      - alert: Redis_Connection_Failed
        expr: up{job="redis"} == 0
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "Connexion à Redis échouée"
          description: "Impossible de se connecter à Redis depuis plus d'1 minute"

      # Alerte si trop de connexions simultanées
      - alert: Too_Many_Connections
        expr: pg_stat_activity_count > 100
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Trop de connexions à la base de données"
          description: "Plus de 100 connexions simultanées à PostgreSQL"

      # Alerte si le rate limiting est déclenché fréquemment
      - alert: High_Rate_Limit_Hits
        expr: rate(rate_limit_exceeded_total[5m]) > 10
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Rate limiting fréquemment déclenché"
          description: "Le rate limiting est déclenché plus de 10 fois par minute"

